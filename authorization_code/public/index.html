<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="/js/songFlip.js" charset="utf-8"></script>
  <!-- <script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script> -->
  <script src="/js/main.js" charset="utf-8"></script>
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/flip.css">
  <!-- <link href="https://fonts.googleapis.com/css?family=Raleway|Roboto" rel="stylesheet"> -->
</head>

<body>
  <header>
    <div id="login" class="hide">
      <h1>Please login to Spotify to play this game.</h1>
      <a href="/login" class="btn btn-primary">Log in with Spotify</a>
      <!-- <button type="button" class="btn btn-primary" value="login">Log in with Spotify</button> -->
      <!-- <script>
        jQuery('button[value="login"]').on('click', function() {
          console.log('button clicked');
          jQuery.ajax({
            url: '/login',
            success: function(data, status, xhr) {
              console.log('logged into');
              console.log(data);
            }
          });
        });

      </script> -->
    </div>
    <div id="loggedin" class="hide">
      <div id="user-profile">
      </div>
      <div id="oauth">
      </div>
      <!-- <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button> -->
      <!-- <button href="/startGame" class="btn btn-primary" id="startGame">Start Game</button> -->
      <!-- <form action="/startGame"> -->
      <!-- <button type="submit" class="btn btn-primary" id="startGame" value="Start Game">Start Game</button> -->
      <!-- <button type="submit" class="btn btn-primary" id="startGame" value="Start Game"> -->
      <button type="button" class="btn btn-primary" id="startGame">Start Game</button>
      <!-- </form> -->
    </div>
  </header>
  <main>
    <div id="gameInterface" class="hide">

      <!-- <div id="song-1"></div>
      <div id="song-2"></div>
      <div id="song-3"></div>
      <div id="song-4"></div>
      <div id="song-5"></div>
      <div id="song-6"></div>
      <div id="song-7"></div>
      <div id="song-8"></div>
      <div id="song-9"></div>
      <div id="song-10"></div> -->

    </div>
  </main>
  <div class="container">


  </div>

</body>
<footer>
  <script>
    /**
     * logging into spotify
     */
    function loadGame() {
      let params = getHashParams();

      let accessToken = params.access_token;
      let refreshToken = params.refresh_token;
      let error = params.error;

      // var userProfileSource = document.getElementById('user-profile-template').innerHTML,
      //   userProfileTemplate = Handlebars.compile(userProfileSource),
      //   userProfilePlaceholder = document.getElementById('user-profile');
      //
      // var oauthSource = document.getElementById('oauth-template').innerHTML,
      //   oauthTemplate = Handlebars.compile(oauthSource),
      //   oauthPlaceholder = document.getElementById('oauth');
      //
      // var params = getHashParams();
      //
      // var access_token = params.access_token,
      //   refresh_token = params.refresh_token,
      //   error = params.error;

      if (error) {
        alert('There was an error during the authentication');
      } else {

        if (accessToken) {
          // RUN THIS IF LOG IN WAS SUCCESSFUL
          /**
           *  Load the Oath Infomration
           */
          // jQuery.ajax({
          //   url: 'templates/oauth-template.hbs',
          //   success: function(data) {
          //     // console.log(typeof data);
          //     console.log(data);
          //     // console.log('grabbed template file');
          //
          //     let oauthTemplate = Handlebars.compile(data);
          //     let oauthPlaceholder = document.getElementById('oauth');
          //
          //     // render oauth info
          //     oauthPlaceholder.innerHTML = oauthTemplate({
          //       access_token: accessToken,
          //       refresh_token: refreshToken,
          //     });
          //   },
          // });

          /**
           *  Load the users profile
           */
          $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + accessToken,
            },
            success: function(response) {
              // console.log('response');
              // console.log(response);
              // userProfilePlaceholder.innerHTML = userProfileTemplate(response);

              jQuery.ajax({
                url: 'templates/user-profile-template.hbs',
                success: function(data) {

                  let userProfileTemplate = Handlebars.compile(data);
                  let userProfilePlaceholder = document.getElementById('user-profile');
                  userProfilePlaceholder.innerHTML = userProfileTemplate(response);

                  $('#login')
                    .hide();
                  $('#gameInterface')
                    .hide();
                  $('#loggedin')
                    .show();

                },
              });

            },
            error: function(xhr, status, e) {
              // if the access token has expired.  Ask the user to sign back in.
              // console.log(xhr);
              // console.log(typeof xhr.status);
              // console.log(status);
              // console.log(e);
              // console.log(xhr.status == 401 && e === 'Unauthorized');
              if (xhr.status == 401 && e === 'Unauthorized') {
                jQuery('body .container').prepend('<span>Connection Timed Out : Please log back into Spotify</span>');
                jQuery('#login').show();
              }
            }
          });
        } else {
          // render initial screen
          $('#login')
            .show();
          $('#gameInterface')
            .hide();
          $('#loggedin')
            .hide();
        }

        // bind event listeners
        // *********************************************
        // document.getElementById('obtain-new-token')
        //   .addEventListener('click', function() {
        //     $.ajax({
        //         url: '/refresh_token',
        //         data: {
        //           'refresh_token': refreshToken,
        //         },
        //       })
        //       .done(function(data) {
        //         accessToken = data.access_token;
        //         oauthPlaceholder.innerHTML = oauthTemplate({
        //           access_token: accessToken,
        //           refresh_token: refreshToken,
        //         });
        //       });
        //   }, false);

        // jQuery('#playSample')
        //   .on('click', function() {
        //     const songPlayer = document.getElementById('songSample');
        //     songPlayer.volume = 0.5;
        //     songPlayer.play();
        //
        //     setTimeout(function() {
        //       songPlayer.pause();
        //       songPlayer.currentTime = 0;
        //     }, 2000);
        //   });

        // BIND EVENT LISTER TO START GAME BUTTON
        jQuery('#startGame')
          .on('click', function() {
            // show the game UI
            jQuery('#gameInterface')
              .show();
            // hide the buttons
            jQuery(this).hide();

            // jQuery.ajax({
            //   url: '/startGame',
            //   data: params,
            //   success: function(data, status, xhr) {
            //     console.log('data recieved');
            //     console.log(data);
            //   },
            // });


            let totalURL = 'https://api.spotify.com/v1/users/cirept612/playlists/5J9c1FAlO3qEnLMLSqZjwu/tracks?market=ES&fields=total&limit=1&offset=1';
            let trackCount;

            if (!trackCount) {
              let songList = {};
              // console.log('get song list');
              jQuery.ajax({
                  'url': totalURL,
                  'async': true,
                  'contentType': 'application/json',
                  'dataType': 'json',
                  'headers': {
                    'Authorization': 'Bearer ' + accessToken,
                  },
                })
                .done(function(data) {
                  // get the total number of songs in the spotify playlist
                  trackCount = data.total;
                  // console.log(data);

                  // set the number of songs that make up the game questions
                  let numberOfSongs = 10;
                  // randomly select X amount of songs from the Spotify playlist
                  let songs = generateSongList(trackCount, numberOfSongs);
                  let songInformation = {};
                  // console.log(songs);
                  let no = 1;
                  // get the track numbers from the playlist
                  const quizQuestions = songs.map(function(x) {
                    let trackURL = 'https://api.spotify.com/v1/users/cirept612/playlists/5J9c1FAlO3qEnLMLSqZjwu/tracks?market=ES&limit=1&offset=' + x;
                    jQuery.ajax({
                      'url': trackURL,
                      'async': false,
                      'contentType': 'application/json',
                      'dataType': 'json',
                      'headers': {
                        'Authorization': 'Bearer ' + accessToken,
                      },
                      success: function(data, status, xhr) {
                        let response = data;
                        // test the songs that were generated
                        // console.log('songs received');
                        // console.log(response.items[0].track);
                        let track = response.items[0].track;
                        songInformation = {
                          song_number: no,
                          preview_url: track.preview_url,
                          name: track.name,
                          id: track.id,
                          artist: track.artists[0].name,
                          album_art: track.album.images[2].url,
                          album_name: track.album.name,
                        };
                        // console.log('my information');
                        // console.log(songInformation);
                        // console.log(no);



                        // build song cards
                        jQuery.ajax({
                          url: 'templates/songCard.hbs',
                          async: false,
                          success: function(data) {
                            // console.log(no);
                            // console.log(data);
                            // debugger;
                            let songCardTemplate = Handlebars.compile(data);
                            let userProfilePlaceholder = document.getElementById('gameInterface');
                            let myDiv = document.createElement('div');
                            myDiv.innerHTML = songCardTemplate(songInformation);
                            myDiv.classList.add('songContainer');
                            userProfilePlaceholder.appendChild(myDiv);
                            // console.log(myDiv);
                            // no += 1;

                            // bind event listener for play button
                            // -----------------------------------
                            // jQuery('#song-' + no + '.audio.songSample').on('click', function() {
                            //   let songPlayer = document.querySelector('#song-' + no + '.audio.songSample');
                            //
                            //   // songPlayer = songPlayer.querySelector('audio.songSample');
                            //   console.log(songPlayer);
                            //   songPlayer.volume = 0.5;
                            //   songPlayer.autoplay = true;
                            //
                            //   setTimeout(function() {
                            //     songPlayer.pause();
                            //     songPlayer.currentTime = 0;
                            //   }, 2000);
                            // });

                            jQuery('button.guessSong')
                              .on('click', function() {
                                jQuery(this).parents('.flip-container')
                                  .addClass('hover');
                              });

                          },
                        });

                        no += 1;
                      }
                    })
                    // .done(function(data) {
                    //   let response = data;
                    //   // test the songs that were generated
                    //   // console.log('songs received');
                    //   // console.log(response.items[0].track);
                    //   let track = response.items[0].track;
                    //   songInformation = {
                    //     preview_url: track.preview_url,
                    //     name: track.name,
                    //     id: track.id,
                    //     artist: track.artists[0].name,
                    //     album_art: track.album.images[2].url,
                    //     album_name: track.album.name,
                    //   };
                    //   // console.log('my information');
                    //   console.log(songInformation);
                    //   let no = 1;
                    //
                    //
                    //
                    //   // build song cards
                    //   jQuery.ajax({
                    //     url: 'templates/songCard.hbs',
                    //     success: function(data) {
                    //       console.log(no);
                    //       console.log(data);
                    //       // debugger;
                    //       let songCardTemplate = Handlebars.compile(data);
                    //       let userProfilePlaceholder = document.getElementById('gameInterface');
                    //       let myDiv = document.createElement('div');
                    //       myDiv.innerHTML = songCardTemplate(songInformation);
                    //       userProfilePlaceholder.appendChild(myDiv);
                    //       console.log(userProfilePlaceholder);
                    //       // no += 1;
                    //
                    //       // bind event listener for play button
                    //       // -----------------------------------
                    //       // jQuery('#song-' + no + '.audio.songSample').on('click', function() {
                    //       //   let songPlayer = document.querySelector('#song-' + no + '.audio.songSample');
                    //       //
                    //       //   // songPlayer = songPlayer.querySelector('audio.songSample');
                    //       //   console.log(songPlayer);
                    //       //   songPlayer.volume = 0.5;
                    //       //   songPlayer.autoplay = true;
                    //       //
                    //       //   setTimeout(function() {
                    //       //     songPlayer.pause();
                    //       //     songPlayer.currentTime = 0;
                    //       //   }, 2000);
                    //       // });
                    //
                    //       jQuery('button.guessSong.one')
                    //         .on('click', function() {
                    //           jQuery('div.song.one.flip-container')
                    //             .toggleClass('hover');
                    //         });
                    //
                    //     },
                    //   });
                    //
                    //
                    // });

                    // TODO create event listener for ajaxStop to fire after all
                    // the song information has been gathered.
                  });
                });
            } else {
              console.log('track count already known');
            }

            // let options = {
            //   url: baseURL + songId,
            //   headers: {
            //     'Accept': 'application/json',
            //     'Content-Type': 'application/json',
            //     'Authorization': 'Bearer ' + accessToken,
            //   },
            //   json: true,
            // };
            //
            // jQuery.get(options);

            // autoplay button and pause after 1 second
            //             jQuery.ajax({
            //                 'url': getURL,
            //                 'async': true,
            //                 'contentType': 'application/json',
            //                 'dataType': 'json',
            //                 'headers': {
            //                   'Authorization': 'Bearer ' + accessToken
            //                 },
            //               })
            //               .done(function(data) {
            //                 console.log(data);
            //                 console.log(data.preview_url);
            //                 jQuery('#songSample').attr('src', data.preview_url);
            //
            // // autoplay

            // });

            // jQuery.ajax();
          });
      }

    }

    jQuery(document)
      .ready(loadGame);

  </script>
</footer>
